# HTTP → HTTPS 리다이렉트 + ACME 챌린지
server {
    listen 80;
    server_name k13s310.p.ssafy.io;

    # certbot 웹루트(HTTP 인증용)
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # 나머지는 HTTPS로 리다이렉트
    location / {
        return 301 https://$host$request_uri;
    }
}

# 실제 HTTPS 서비스
server {
    listen 443 ssl http2;
    server_name k13s310.p.ssafy.io;

    ssl_certificate     /etc/letsencrypt/live/k13s310.p.ssafy.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/k13s310.p.ssafy.io/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    add_header Strict-Transport-Security "max-age=15552000; includeSubDomains" always;

    # Vite 빌드된 정적 파일
    root /usr/share/nginx/html;
    index index.html;

    # Swagger UI 프록시
    location /swagger-ui {
        proxy_pass http://be-kakaon:8080/swagger-ui;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }

    # SPA 라우팅 대응 (React Router)
    location / { 
        try_files $uri /index.html; 
    }

    # 백엔드 API 프록시
    location /api {
        proxy_pass http://be-kakaon:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }   

    # OAuth2 로그인 API 프록시
    location /oauth2 {
        proxy_pass http://be-kakaon:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }

    # OAuth2 콜백 API 프록시
    location /login {
        proxy_pass http://be-kakaon:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }
}

